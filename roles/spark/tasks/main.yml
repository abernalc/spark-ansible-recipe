---
- name: Update repositories cache
  yum:
    update_cache: yes

- name: Install java 8
  yum:
    name: java
    state: present

- name: Add spark user
  user:
    name: "{{ spark_user }}"
    create_home: true
    home: "{{ spark_user_home }}"

- name: Check {{ spark_user_home }} permissions
  file:
    path: "{{ spark_user_home }}"
    state: directory
    mode: 0766

- name: Check if the {{ spark_base_path }} exists
  file:
    path: "{{ spark_base_path }}"
    state: directory

- name: Untar the {{ spark_package }}
  unarchive:
    src: "{{ spark_package }}"
    dest: "{{ spark_base_path }}"
    remote_src: yes
    extra_opts: [--strip-components=1]
    owner: "{{ spark_user }}"
    group: "{{ spark_user }}"
  tags:
     - untar

- name: Setup spark environment variables
  blockinfile:
    path: "{{ bash_file }}"
    marker: "# {mark} SPARK environment variables"
    block: |
          SPARK_HOME={{ spark_base_path }}
          export PATH=$SPARK_HOME/bin:$PATH
    state: present

- name: create the {{ spark_env_file }} from the template
  copy: 
    src: "{{ spark_env_template }}"
    dest: "{{ spark_env_file }}"
    remote_src: yes
    owner: "{{ spark_user }}"
    group: "{{ spark_user }}"

- name: Setup {{ spark_local_ip  }} 
  blockinfile:
    path: "{{ spark_env_file }}"
    marker: "# {mark} hosts"
    block: |
          {{ spark_local_ip  }}={{ ansible_default_ipv4.address }}
    state: present

#  To work with hostnames 
#- name: Setup {{ host_file  }}
#  blockinfile:
#    path: "{{ host_file }}"
#    marker: "# {mark} hosts {{item}}"
#    block: |
#          {{ hostvars[item]['ansible_default_ipv4']['address'] }}  {{ hostvars[item]['ansible_facts']['hostname'] }}
#    state: present
#  with_items:
#    - "{{ groups['spark_slaves'] }}"
#    - "{{ groups['spark_masters'] }}"
#  tags:
#     - hostfile

- name: Create {{ spark_master_service_file }} directory
  file:
    path: "{{ spark_master_service_file }}"
    state: touch
  when: "'spark_masters' in group_names"

- name: Populating the {{ spark_master_service_file  }}
  blockinfile:
    path: "{{ spark_master_service_file }}"
    marker: "# {mark} Spark master service file"
    block: |
          [Unit]
          Description=Spark master service
          After=syslog.target network.target

          [Service]
          Type=forking
          ExecStart={{ start_master_script }} -h {{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}
          ExecStop={{ stop_master_script }}
          User={{ spark_user }}
          Group={{ spark_user }}
          Restart=always

          [Install]
          WantedBy=multi-user.target
    state: present
  when: "'spark_masters' in group_names"

- name: Make sure spark master service is running
  systemd:
    state: started
    daemon_reload: yes
    name: spark-master
  when: "'spark_masters' in group_names"

- name: Create {{ spark_slave_service_file }} directory
  file:
    path: "{{ spark_slave_service_file }}"
    state: touch
  when: "'spark_slaves' in group_names"

- name: Populating the {{ spark_slave_service_file  }}
  blockinfile:
    path: "{{ spark_slave_service_file }}"
    marker: "# {mark} Spark slave service file"
    block: |
          [Unit]
          Description=Spark slave service
          After=syslog.target network.target

          [Service]
          Type=forking
          ExecStart={{ start_slave_script }} spark://{{ hostvars[groups['spark_masters'][0]]['ansible_default_ipv4']['address'] }}:7077 -h {{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}
          ExecStop={{ stop_slave_script }}
          User={{ spark_user }}
          Group={{ spark_user }}
          Restart=always

          [Install]
          WantedBy=multi-user.target
    state: present
  when: "'spark_slaves' in group_names"

- name: Make sure spark slave service is running
  systemd:
    state: started
    daemon_reload: yes
    name: spark-slave
  when: "'spark_slaves' in group_names"

# Testing purposes
#- name: Check slave1 address
#  debug: var=hostvars['slave1']['ansible_default_ipv4']['address']
#  tags:
#     - check
